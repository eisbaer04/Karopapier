{% extends 'base.html.twig' %}

{% block headjavascripts %}
    <script src="/js/libs/underscore-1.8.3.js"></script>
    <script src="/js/libs/backbone-1.3.3.js"></script>
    <script src="/js/libs/backbone.radio-2.0.0.js"></script>
    <script src="/js/libs/backbone.marionette-3.4.3.js"></script>
{% endblock %}

{% block body %}
    <h1 class="karoborder">Zettel schreiben</h1>
    <p>Hier kannst Du Deinen Mitspielern einen Zettel schicken, den dann hoffentlich die Sitznachbarn weitergeben ohne reinzuschauen.</p>
    <div id="content">Lala</div>
{% endblock %}

{% block javascripts %}
    <script type="text/template" id="send-template">
        An
        <span class="userDropdown"></span>: <input type="text">
        <button>Send</button>
    </script>

    <script type="text/template" id="messaging-template">
        <div class="contact-list"></div>
        <div class="message-list"></div>
        <div class="send-view"></div>
    </script>

    <script type="text/template" id="message-template"></script>

    <script type="text/javascript">

        var UserCollection = Backbone.Collection.extend({
            url: "/api/users"
        });

        var MessageCollection = Backbone.Collection.extend({
            url: "/api/messages"
        });

        window.USERS = new UserCollection(
                {{ users|json_encode|raw }}
        );
        window.MESSAGES = new MessageCollection();
        window.MESSAGES.fetch();

        var ContactCollection = Backbone.Collection.extend({
            url: "/api/contacts"
        });

        var contacts = new ContactCollection();
        contacts.fetch();

        var Message = Backbone.Model.extend();

        var SendView = Marionette.View.extend({
            events: {
                "click button": "send"
            },
            template: "#send-template",
            regions: {
                "users": '.userDropdown'
            },
            onRender: function() {
                this.getRegion("users").show(new UserDropdownView({
                    collection: USERS
                }));
            },

            send: function() {
                var text = this.$('input').val();
                var userId = this.$('select').val();
                console.log("Nachricht", text, "an", userId);
                window.MESSAGES.create({
                    userId: userId,
                    text: text
                }, {wait: true});
            }
        });

        var UserDropdownView = Marionette.View.extend({
            tagName: "select",
            template: false,
            onRender: function() {
                var html = '';
                this.collection.each(function(m) {
                    html += '<option value="' + m.get("id") + '">' + m.get("login") + '</option>';
                });
                this.$el.html(html);
            }
        });

        var MessagingLayout = Marionette.View.extend({
            template: "#messaging-template",
            regions: {
                send: ".send-view",
                messages: ".message-list",
                contacts: ".contact-list"
            }
        });

        var MessageView = Marionette.View.extend({
            template: _.template("<%= ts %>: <%= contact_name %>: <%- text %> <%= rxtx %>")
        });
        var MessagesView = Marionette.CollectionView.extend({
            childView: MessageView
        });

        var ContactView = Marionette.View.extend({
            template: _.template("<%= login %>"),
            triggers: {
                "click": "contact:select"
            }
        });

        var ContactsView = Marionette.CollectionView.extend({
            childView: ContactView
        });

        var MessagingApp = Marionette.Application.extend({
            initialize: function() {
                this.messagingLayout = new MessagingLayout({
                    el: '#content'
                });
            },

            start: function() {
                var me = this;
                this.messagingLayout.render();

                this.contactsView = new ContactsView({
                    collection: contacts
                });

                this.messagingLayout.getRegion("send").show(new SendView());
                this.messagingLayout.getRegion("contacts").show(this.contactsView);

                this.listenTo(this.contactsView, "childview:contact:select", function(e, v) {
                    var contact = e.model;
                    me.select(contact);
                });
            },

            select: function(contact) {
                var userMessages = new ContactCollection(MESSAGES.where({
                    contact_id: contact.get("id")
                }));
                console.log(userMessages);
                this.messagingLayout.getRegion("messages").show(new MessagesView({
                    collection: userMessages
                }));
            }
        });

        $(document).ready(function() {
            window.app = new MessagingApp();
            app.start();
        });

    </script>
{% endblock %}
