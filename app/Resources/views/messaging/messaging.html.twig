{% extends 'base.html.twig' %}

{% block headjavascripts %}
    <script src="/js/libs/underscore-1.8.3.js"></script>
    <script src="/js/libs/backbone-1.3.3.js"></script>
    <script src="/js/libs/backbone.radio-2.0.0.js"></script>
    <script src="/js/libs/backbone.marionette-3.4.3.js"></script>
{% endblock %}

{% block body %}
    <h1 class="karoborder">Mitteilungen</h1>
    <div id="content">Lala</div>
{% endblock %}

{% block javascripts %}
    <script type="text/template" id="send-template">
        An
        <span class="userDropdown"></span>: <input type="text">
        <button>Send</button>
    </script>

    <script type="text/template" id="messaging-template">
        <div class="contact-list"></div>
        <div class="message-list"></div>
        <div class="send-view"></div>
    </script>

    <script type="text/template" id="message-template"></script>

    <script type="text/javascript">

        var UserCollection = Backbone.Collection.extend({
            url: "/api/users"
        });

        var MessageCollection = Backbone.Collection.extend({
            url: "/api/messages"
        });

        window.USERS = new UserCollection(
                {{ users|json_encode|raw }}
        );
        window.MESSAGES = new MessageCollection();
        window.MESSAGES.fetch();

        var Message = Backbone.Model.extend();

        var SendView = Marionette.View.extend({
            events: {
                "click button": "send"
            },
            template: "#send-template",
            regions: {
                "users": '.userDropdown'
            },
            onRender: function() {
                this.getRegion("users").show(new UserDropdownView({
                    collection: USERS
                }));
            },

            send: function() {
                var text = this.$('input').val();
                var userId = this.$('select').val();
                console.log("Nachricht", text, "an", userId);
                window.MESSAGES.create({
                    userId: userId,
                    text: text
                }, {wait: true});
            }
        });

        var UserDropdownView = Marionette.View.extend({
            tagName: "select",
            template: false,
            onRender: function() {
                var html = '';
                this.collection.each(function(m) {
                    html += '<option value="' + m.get("id") + '">' + m.get("login") + '</option>';
                });
                this.$el.html(html);
            }
        });

        var MessagingLayout = Marionette.View.extend({
            template: "#messaging-template",
            regions: {
                send: ".send-view",
                messages: ".message-list"
            }
        });

        var MessageView = Marionette.View.extend({
            template: _.template("<%= ts %>: <%= contact_name %>: <%- text %> <%= rxtx %>")
        });
        var MessagesView = Marionette.CollectionView.extend({
            childView: MessageView
        });

        $(document).ready(function() {
            var messagingLayout = new MessagingLayout({
                el: '#content'
            });
            messagingLayout.render();

            messagingLayout.getRegion("send").show(new SendView());
            messagingLayout.getRegion("messages").show(new MessagesView({
                collection: MESSAGES
            }));
        });

    </script>
{% endblock %}
